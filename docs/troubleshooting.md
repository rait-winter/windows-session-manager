# Windows会话管理器 故障排除指南

本文档提供了使用Windows会话管理器时可能遇到的常见问题及其解决方案。

## 目录

1. [启动问题](#启动问题)
2. [窗口检测问题](#窗口检测问题)
3. [会话恢复问题](#会话恢复问题)
4. [窗口位置问题](#窗口位置问题)
5. [配置文件问题](#配置文件问题)
6. [UI相关问题](#ui相关问题)
7. [性能问题](#性能问题)
8. [日志查看](#日志查看)
9. [完全重置](#完全重置)
10. [常见错误代码](#常见错误代码)

## 启动问题

### 程序无法启动

**症状**：双击程序或使用命令行运行程序时，程序没有显示窗口或立即退出。

**可能原因和解决方案**：

1. **缺少依赖库**
   - 确保已安装所有必要的Python库：
     ```
     pip install -r requirements.txt
     ```

2. **Python版本不兼容**
   - 确保使用Python 3.6或更高版本
   - 检查是否有多个Python版本，尝试使用完整路径运行：
     ```
     C:\Python38\python.exe get_windows.py
     ```

3. **配置文件损坏**
   - 删除配置文件，让程序重新生成：
     ```
     del %APPDATA%\Local\WSM\WindowsSessionManager\config.json
     ```

4. **权限问题**
   - 以管理员身份运行程序
   - 检查用户数据目录的权限

5. **查看日志文件**
   - 检查日志文件以获取详细错误信息：
     ```
     type %APPDATA%\Local\WSM\WindowsSessionManager\session_manager.log
     ```

### 命令行参数不起作用

**症状**：使用命令行参数运行程序，但参数没有预期效果。

**解决方案**：

1. 检查参数格式是否正确，注意大小写
2. 对包含空格的参数使用引号：
   ```
   python get_windows.py --save "我的工作环境"
   ```
3. 查看帮助获取正确的参数格式：
   ```
   python get_windows.py --help
   ```

## 窗口检测问题

### 无法检测某些应用程序

**症状**：某些应用程序窗口不被保存到会话中。

**可能原因和解决方案**：

1. **应用程序在排除列表中**
   - 检查`exclude_process_paths`和`exclude_window_titles`配置，确保目标应用不在排除列表中

2. **非标准窗口**
   - 某些应用程序使用自定义窗口管理，可能无法被正常检测
   - 对于特殊应用，可以将其添加到`special_apps`列表中

3. **权限问题**
   - 如果目标应用以更高权限运行，会话管理器也需要以管理员身份运行

4. **检查窗口层次结构**
   - 使用调试菜单中的"枚举所有窗口"功能检查窗口是否可见

### 保存了不需要的窗口

**症状**：会话中包含了一些不需要的系统窗口或后台程序。

**解决方案**：

1. 更新排除列表：
   - 在配置文件中添加不需要的窗口标题到`exclude_window_titles`
   - 添加不需要的进程路径到`exclude_process_paths`

2. 手动从会话中删除不需要的窗口

## 会话恢复问题

### 应用程序无法启动

**症状**：恢复会话时，某些应用程序无法正常启动。

**可能原因和解决方案**：

1. **应用程序路径不正确**
   - 检查应用程序路径是否存在且正确
   - 如果应用已移动位置，需要更新会话数据

2. **应用程序需要特殊参数**
   - 某些应用程序需要特定的命令行参数才能启动
   - 对于此类应用，可能需要在代码中添加特殊处理

3. **权限问题**
   - 如果应用需要管理员权限，会话管理器也需要以管理员身份运行

4. **增加启动延迟**
   - 增加`restore_delay_seconds`值，给应用程序更多启动时间：
     ```json
     "restore_delay_seconds": 0.5
     ```

### 特定应用程序总是恢复失败

**症状**：某个特定的应用程序在恢复时总是失败。

**解决方案**：

1. 为特定应用添加特殊处理：
   - 在`core.py`中为该应用添加特殊启动逻辑
   - 将应用添加到特殊应用列表

2. 检查应用程序启动参数：
   - 某些应用程序可能需要特定参数或工作目录
   - 手动尝试从命令行启动应用程序，观察是否成功

3. 增加重试次数：
   - 在配置中增加`advanced.max_restore_retries`值

## 窗口位置问题

### 窗口位置不正确

**症状**：恢复会话后，窗口位置与保存时不同。

**可能原因和解决方案**：

1. **显示器配置变化**
   - 如果显示器配置（分辨率、数量、排列）与保存时不同，窗口位置可能不正确
   - 尝试在相同的显示器配置下保存和恢复会话

2. **应用程序自行决定窗口位置**
   - 某些应用程序会忽略外部窗口位置设置，总是使用自己的默认位置
   - 这类应用可能无法准确恢复位置

3. **调整窗口位置恢复逻辑**
   - 如果经常遇到此问题，可以修改`core.py`中的窗口位置恢复逻辑

### 多显示器问题

**症状**：在多显示器环境下，窗口可能恢复到错误的显示器上。

**解决方案**：

1. 确保显示器配置（主副屏幕位置、分辨率）与保存时一致
2. 修改配置中的虚拟桌面支持设置：
   ```json
   "advanced": {
       "virtual_desktop_support": true
   }
   ```
3. 手动调整窗口位置后重新保存会话

## 配置文件问题

### 配置文件损坏

**症状**：程序启动后使用默认设置，自定义设置丢失，或程序无法启动。

**解决方案**：

1. 恢复备份的配置文件（如果有）
2. 删除损坏的配置文件，让程序重新创建默认配置：
   ```
   del %APPDATA%\Local\WSM\WindowsSessionManager\config.json
   ```
3. 手动编辑JSON文件，确保格式正确

### 配置更改不生效

**症状**：修改配置文件后，更改似乎没有生效。

**解决方案**：

1. 确保保存了配置文件更改
2. 重启程序，某些配置只有在重启后才会生效
3. 检查JSON格式是否正确，特别是引号、逗号和括号
4. 使用有效的JSON编辑器编辑配置文件

## UI相关问题

### 界面显示异常

**症状**：界面元素显示不正确，布局混乱或控件缺失。

**解决方案**：

1. **尝试不同主题**
   - 在配置文件中更改主题：
     ```json
     "ui": {
         "theme": "vista"  // 尝试: "winnative", "clam", "alt", "default", "classic", "xpnative"
     }
     ```

2. **调整窗口大小**
   - 修改窗口初始大小：
     ```json
     "ui": {
         "window_width": 1000,
         "window_height": 750
     }
     ```

3. **调整字体大小**
   - 如果文字显示异常，调整字体大小：
     ```json
     "ui": {
         "font_size": 10
     }
     ```

4. **重置UI配置**
   - 删除配置文件中的ui部分，让程序重新创建默认UI配置

### 托盘图标问题

**症状**：系统托盘图标显示异常或缺失。

**解决方案**：

1. 确保资源目录中的图标文件存在且未损坏
2. 检查是否安装了最新版本的Pillow库
3. 重新生成图标文件：
   ```
   python create_icons.py
   ```

## 性能问题

### 程序响应缓慢

**症状**：程序界面响应迟钝，操作有明显延迟。

**解决方案**：

1. **减少会话大小**
   - 删除不必要的窗口和应用程序
   - 使用更多的排除规则过滤系统窗口

2. **禁用不必要的功能**
   - 在配置中禁用窗口图标收集：
     ```json
     "advanced": {
         "collect_window_icons": false
     }
     ```
   - 禁用会话历史记录：
     ```json
     "advanced": {
         "keep_session_history": false
     }
     ```

3. **增加启动延迟**
   - 增加启动延迟，让系统有更多时间初始化：
     ```json
     "startup_delay_seconds": 5
     ```

### 内存使用过高

**症状**：程序占用过多内存资源。

**解决方案**：

1. 清理过大的会话数据文件
2. 减少自动保存频率：
   ```json
   "advanced": {
       "auto_save_interval": 600  // 10分钟
   }
   ```
3. 限制保存的会话历史记录数量：
   ```json
   "advanced": {
       "max_session_history": 5
   }
   ```

## 日志查看

Windows会话管理器会生成日志文件，这是诊断问题的重要资源。

### 日志文件位置

日志文件位于用户数据目录：
```
%APPDATA%\Local\WSM\WindowsSessionManager\session_manager.log
```

### 增加日志详细程度

要获取更详细的日志，可以修改日志级别：

1. 修改`config.py`中的`logging.basicConfig`：
   ```python
   logging.basicConfig(
       level=logging.DEBUG,  # 改为DEBUG以获取更详细日志
       ...
   )
   ```

2. 或者在启动程序时使用调试标志（如果已实现）：
   ```
   python get_windows.py --debug
   ```

### 常见日志信息解析

以下是一些常见日志信息及其含义：

- `配置已从 ... 加载`：成功加载配置文件
- `配置文件不存在，创建默认配置`：第一次运行或配置文件缺失
- `会话数据收集完成。共收集到 X 个相关窗口/应用条目`：成功收集窗口信息
- `发现特殊应用: X`：检测到特殊应用程序
- `启动应用: X`：尝试启动应用程序
- `启动应用失败: X`：应用程序启动失败，后面会有具体错误

## 完全重置

如果遇到严重问题，可以尝试完全重置程序：

1. **备份重要会话**
   - 先导出重要的会话数据

2. **删除用户数据目录**
   - 关闭程序
   - 删除用户数据目录：
     ```
     rmdir /S /Q %APPDATA%\Local\WSM\WindowsSessionManager
     ```

3. **重新安装依赖**
   - 重新安装所有依赖库：
     ```
     pip install -r requirements.txt --force-reinstall
     ```

4. **重启程序**
   - 启动程序，此时将使用默认配置

## 常见错误代码

以下是一些可能在日志中看到的常见错误代码及其解决方案：

### 错误：WindowsError: [Error 2]
**含义**：找不到指定的文件
**解决方案**：检查应用程序路径是否存在，可能需要更新会话数据中的路径

### 错误：WindowsError: [Error 5]
**含义**：拒绝访问
**解决方案**：以管理员身份运行程序，或检查文件/目录权限

### 错误：TypeError: ... NoneType ...
**含义**：尝试对None值执行操作
**解决方案**：检查代码中的空值处理，可能是窗口检测失败导致

### 错误：ValueError: ... JSON ...
**含义**：JSON解析错误
**解决方案**：检查配置文件或会话数据文件的JSON格式是否正确

### 错误：ImportError: No module named ...
**含义**：缺少必要的Python库
**解决方案**：安装缺失的库：`pip install <库名称>`

## 1. 采集不到真实标签页

- 检查浏览器是否正在运行，部分session文件可能被锁定，建议关闭浏览器后再采集。
- 检查浏览器profile目录权限，确保当前用户有读权限。
- 对于Chromium内核浏览器，部分标签页可能只能通过历史数据库兜底，无法100%还原窗口-标签页结构。

## 2. 标签页分配不准/重复

- 采集逻辑基于窗口标题与tab标题相似度分配，部分情况下可能分配不准。
- 可尝试优化窗口标题命名，或手动调整分配算法。

## 3. 历史数据库无法访问

- 检查`History`数据库文件是否被浏览器占用。
- 可尝试关闭浏览器后再采集，或复制数据库到临时文件再读取。

## 4. 恢复会话后部分窗口未打开

- 某些应用或浏览器可能需要手动启动，或因路径配置不正确导致恢复失败。

## 5. 其它常见问题

- 会话数据丢失：请定期导出/备份`sessions.json`。
- GUI显示异常：尝试重启程序或检查依赖库版本。

---

> 本项目所有数据均本地保存，遇到问题可查阅本指南或提交issue。 