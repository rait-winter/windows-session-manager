# Windows 会话管理器 - 使用文档

本文档详细介绍了 Windows 会话管理器工具的各项功能、使用方法以及高级配置。

## 1. 图形用户界面 (GUI)

直接运行 `get_windows.py` 脚本（不带命令行参数）即可打开 GUI 界面。

```bash
python D:\project\SessionManager\get_windows.py
```

GUI 界面分为几个主要区域：

*   **顶部控制区：** 包含选择会话下拉列表和主要操作按钮。
*   **会话条目列表：** 显示当前选中会话中包含的应用程序/浏览器条目。
*   **日志输出：** 显示工具的运行日志和状态信息。
*   **状态栏：** 窗口底部显示当前操作的简要状态。

### 顶部控制区

*   **选择会话:**
    *   一个下拉列表，显示所有已保存的会话名称。
    *   选择不同的会话名称，下方的"会话条目"列表将显示该会话保存的内容。
*   **保存当前会话...:**
    *   点击此按钮将收集当前桌面上所有符合条件的应用程序和浏览器信息。
    *   会弹出一个对话框，提示您输入要保存的会话名称。输入名称后点击"确定"，当前会话数据将以该名称保存。
    *   如果输入的名称已存在，将会覆盖之前的会话记录。
*   **恢复选中会话:**
    *   点击此按钮将尝试恢复当前在"选择会话"下拉列表中选中的会话。
    *   工具会遍历选中会话中的所有条目，尝试启动或切换到相应的应用程序窗口。
    *   详细的恢复过程（查找现有窗口、聚焦、启动新实例）请参考下方日志输出的说明。
*   **刷新列表:**
    *   点击此按钮将重新从 `sessions.json` 文件加载所有会话数据，并更新"选择会话"下拉列表和当前显示的"会话条目"列表。如果在外部修改了会话数据文件，可以使用此功能刷新界面。

### 会话条目列表

这是一个表格 (`Treeview`)，显示当前选中会话中保存的每个应用程序或浏览器的信息。

*   **列:**
    *   **类型:** 显示是"应用"还是"浏览器"。
    *   **标题:** 显示保存时窗口的标题。
    *   **路径:** 显示应用程序的可执行文件完整路径。
*   **交互:**
    *   **单击:** 选中一个或多个条目（按住 `Ctrl` 或 `Shift` 进行多选）。选中的条目会高亮显示。
    *   **双击:** 双击列表中的一个条目，工具将尝试启动或切换到该应用程序。
    *   **右键菜单:** 右键单击列表中的条目，会弹出一个上下文菜单，提供"打开/切换到此应用"和"删除选中条目"的选项，功能与双击和下方按钮相同。

### 会话条目管理按钮

在"会话条目"列表下方，提供了一些用于管理当前选中会话中条目的按钮：

*   **删除选中条目:**
    *   删除在"会话条目"列表中当前选中的所有条目。
    *   删除后会自动保存对当前会话的更改。
    *   此操作不可撤销，请谨慎使用。
*   **清空当前会话:**
    *   删除当前选中会话中的所有条目，但保留该会话名称。
    *   清空后会自动保存对当前会话的更改。
    *   此操作不可撤销，请谨慎使用。
*   **删除当前会话:**
    *   永久删除当前在"选择会话"下拉列表中选中的整个会话（包括会话名称和所有条目）。
    *   删除后会自动保存所有会话数据（已删除的会话将不再出现）。
    *   此操作不可撤销，请谨慎使用。
*   **打开数据目录:**
    *   打开存放 `sessions.json` 和 `config.json` 文件以及日志文件的文件夹。方便您手动查看或修改这些文件。

### 日志输出

该区域显示工具运行时的详细日志信息，包括：

*   应用程序启动信息
*   配置文件加载情况
*   会话数据加载和保存情况
*   会话收集过程（识别到哪些窗口、过滤了哪些窗口）
*   会话恢复过程（尝试启动/切换哪些应用、是否成功、遇到的错误等）
*   用户操作（点击了哪些按钮，进行了哪些操作）
*   警告和错误信息

当您遇到问题时，查看此区域的日志输出可以帮助诊断原因。日志文件也会同时保存到 `session_manager.log` 文件中。

### 状态栏

窗口底部的一条信息栏，显示当前工具的简要状态，例如"准备就绪"、"正在保存..."、"恢复完成"等。

## 2. 命令行接口 (CLI)

除了 GUI，您还可以通过命令行运行脚本来执行特定的操作。这主要用于通过任务计划程序实现自动化。

打开命令行窗口（命令提示符或 PowerShell），切换到脚本所在的目录：

```bash
cd D:\project\SessionManager
```

然后使用以下命令：

*   **保存当前会话到默认会话 (名称为 "上次会话")：**
    ```bash
    python get_windows.py --save
    ```
    此命令会收集当前窗口信息，并覆盖 `sessions.json` 文件中名为 "上次会话" 的记录。
*   **恢复默认会话 (名称为 "上次会话")：**
    ```bash
    python get_windows.py --restore
    ```
    此命令会加载 `sessions.json` 文件中名为 "上次会话" 的记录，并尝试恢复其中的应用程序和浏览器。
*   **打开会话数据文件所在的目录：**
    ```bash
    python get_windows.py --manage
    ```
    此命令会直接打开存放配置和会话数据文件的文件夹，方便您手动编辑。

## 3. 配置文件 (`config.json`)

配置文件允许您自定义工具的行为，而无需修改脚本代码。第一次运行脚本时，如果 `config.json` 不存在，会自动创建默认配置文件。

`config.json` 文件的默认内容如下：

```json
{
    "session_data_file": "sessions.json",
    "exclude_process_paths": [
        "C:\\Windows\\explorer.exe",
        "C:\\Windows\\System32\\ApplicationFrameHost.exe",
        "C:\\Windows\\SystemApps\\MicrosoftWindows.Client.CBS_cw5n1h2txyewy\\TextInputHost.exe",
        "C:\\Windows\\ImmersiveControlPanel\\SystemSettings.exe",
        "C:\\Windows\\System32\\cmd.exe",
        "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
        "C:\\Program Files\\WindowsApps\\Microsoft.CursorStudio_*.exe"
    ],
    "exclude_window_titles": [
        "Program Manager",
        "dummyLayeredWnd",
        "Microsoft Text Input Application",
        "设置"
    ],
    "browser_executables": [
        "chrome.exe",
        "msedge.exe",
        "firefox.exe",
        "opera.exe"
    ],
    "window_title_similarity_threshold": 0.7,
    "restore_delay_seconds": 0.1,
    "backup_session_data": true,
    "default_session_name": "上次会话",
    "startup_delay_seconds": 2
}
```

您可以根据需要修改这些配置项：

*   `session_data_file`: 会话数据文件相对于脚本目录的路径和文件名。默认为 `sessions.json`。
*   `exclude_process_paths`: 一个列表，包含您不希望在保存会话时记录的应用程序可执行文件的完整路径。请确保路径分隔符使用双反斜杠 `\\` 或单斜杠 `/`。
*   `exclude_window_titles`: 一个列表，包含您不希望记录的窗口标题的精确匹配。例如，系统设置窗口、一些应用的辅助窗口等。
*   `browser_executables`: 一个列表，包含您认为属于浏览器的可执行文件名（不含路径）。这用于将这些应用标识为"浏览器"类型，虽然目前对恢复行为没有特殊处理，但为未来扩展留下了可能。
*   `window_title_similarity_threshold`: 在恢复时，当找到多个同路径的现有窗口时，用于判断窗口标题相似度的阈值（0.0 到 1.0 之间）。值越高，要求标题越相似才会被认为是匹配的窗口。
*   `restore_delay_seconds`: 在恢复时，如果窗口被最小化，尝试先恢复窗口，然后等待几秒（浮点数）再尝试聚焦。这有助于确保窗口准备就绪。
*   `backup_session_data`: 一个布尔值（`true` 或 `false`），控制在每次保存会话数据之前是否创建 `sessions.json.bak` 备份文件。建议保持为 `true`。
*   `default_session_name`: 通过命令行 `--save` 和 `--restore` 参数操作时，默认使用的会话名称。默认为"上次会话"。
*   `startup_delay_seconds`: 通过任务计划程序在系统启动时运行 `--restore` 命令时，在执行实际恢复操作前等待的秒数。这有助于系统服务和应用程序在恢复前有时间加载完成。

**修改配置文件后，请保存文件。** GUI 界面在启动时会加载配置，命令行模式每次运行时也会加载最新配置。

## 4. 自动化：通过任务计划程序实现自动保存和恢复

要让工具在系统关机时自动保存，在开机登录后自动恢复，您需要使用 Windows 的任务计划程序进行设置。

**重要：** 某些应用程序（例如以管理员权限运行的应用程序）的窗口可能无法被非管理员权限的程序控制。为了确保工具能够恢复这些应用程序，**建议将保存和恢复任务都设置为以最高权限运行**。

### 任务一：系统关机前自动保存会话

此任务在系统即将关机时触发，运行 `--save` 命令保存当前会话。

1.  **打开任务计划程序：** 在 Windows 搜索栏输入"任务计划程序"并打开。
2.  在左侧导航窗格中，展开"任务计划程序库"。
3.  在右侧"操作"窗格中，点击"创建任务..."。
4.  **"常规"选项卡：**
    *   **名称：** 输入一个描述性的名称，例如 `保存用户工作会话 (自动)`。
    *   **描述：** 可以添加一些说明，例如 `在系统关机前自动保存当前打开的应用和浏览器信息到默认会话。`
    *   **安全性选项：**
        *   选择"不论用户是否登录都要运行"（或者根据您的安全策略选择合适的用户，但需要确保该用户有足够的权限运行脚本和访问文件）。
        *   **勾选"使用最高权限运行"**。这是为了确保工具能够获取和操作所有应用程序窗口，包括以管理员权限运行的程序。
5.  **"触发器"选项卡：**
    *   点击"新建..."。
    *   "开始任务"：选择"出现特定事件时"。
    *   设置：
        *   日志：`System`
        *   源：`User32`
        *   事件 ID：`1074`
    *   （事件 ID 1074 表示系统关机或重启事件。如果您只想在关机时触发，可能需要结合更多条件，但 1074 通常足够。）
    *   点击"确定"。
6.  **"操作"选项卡：**
    *   点击"新建..."。
    *   操作：选择"启动程序"。
    *   程序或脚本：
        *   如果您没有将 Python 打包成 `.exe`：输入 Python 解释器的完整路径。例如：`C:\Users\您的用户名\AppData\Local\Programs\Python\Python39\python.exe` （请替换为您的实际路径）。
        *   如果您已经使用 PyInstaller 打包成 `.exe`：输入生成的 `.exe` 文件的完整路径。例如：`D:\project\SessionManager\SessionManager.exe`。
    *   添加参数(可选)：输入 `--save`
    *   起始于(可选)：输入脚本或 `.exe` 文件所在的目录路径。例如：`D:\project\SessionManager` （请替换为您的实际路径）。
    *   点击"确定"。
7.  **"条件"选项卡：** 根据您的需求配置。例如，如果只希望在交流电源下运行，可以勾选"只在交流电源下时才启动"。
8.  **"设置"选项卡：** 根据您的需求配置。建议勾选"允许按需运行任务"。对于关机任务，其他设置通常可以保留默认。
9.  点击"确定"保存任务。系统可能会提示您输入用户密码。

### 任务二：用户登录后自动恢复会话

此任务在用户登录系统后触发，运行 `--restore` 命令恢复会话。

1.  **打开任务计划程序：** 同上，创建新任务。
2.  **"常规"选项卡：**
    *   **名称：** 输入一个描述性的名称，例如 `恢复用户工作会话 (自动)`。
    *   **描述：** `在用户登录后自动恢复上次保存的应用和浏览器会话。`
    *   **安全性选项：**
        *   选择"只在用户登录时运行"。确保选择您希望自动恢复会话的那个用户账户。
        *   **勾选"使用最高权限运行"**。
3.  **"触发器"选项卡：**
    *   点击"新建..."。
    *   设置：
        *   选择特定用户（如果您在"常规"选项卡选择了"只在用户登录时运行"）。
    *   **勾选"延迟任务直到(随机延迟)"并设置一个合理的延迟时间（例如 30 秒到 1 分钟）**。这很重要，可以确保系统和桌面环境完全加载后再尝试启动应用程序，避免恢复失败。脚本中的 `startup_delay_seconds` 配置项是针对 CLI 模式恢复时在执行核心恢复逻辑前的额外等待时间，这里设置的任务延迟是任务本身启动的延迟。两者可以配合使用。
    *   点击"确定"。
4.  **"操作"选项卡：**
    *   点击"新建..."。
    *   操作：选择"启动程序"。
    *   程序或脚本：
        *   如果您没有打包：Python 解释器的完整路径（同上）。
        *   如果您已打包：生成的 `.exe` 文件的完整路径（同上）。
    *   添加参数(可选)：输入 `--restore`
    *   起始于(可选)：输入脚本或 `.exe` 文件所在的目录路径（同上）。
    *   点击"确定"。
5.  **"条件"选项卡：** 根据您的需求配置。
6.  **"设置"选项卡：** 根据您的需求配置。可以勾选"如果任务失败，按下列频率重新启动:"。

### 测试自动化任务

完成任务计划程序设置后，您可以尝试注销/关机并重新登录/开机，观察任务是否按预期执行。查看 `session_manager.log` 文件可以帮助您判断任务是否成功运行以及恢复过程中是否有错误。

**手动测试 Task Scheduler 任务：**

您也可以在任务计划程序库中选中您创建的任务，然后在右侧"操作"窗格中点击"运行"来手动测试保存或恢复操作。

## 5. 局限性与未来可能的改进

*   **浏览器标签页：** 这是目前最大的局限。精确保存和恢复所有主流浏览器所有标签页的最佳方案通常是开发浏览器扩展并与主程序通信，这需要大量额外工作。一个折衷方案是研究和解析浏览器会话文件（如 Chrome 的 Session、Tabs 文件），但这非常不稳定且容易因浏览器更新而失效。
*   **窗口位置和大小：** 当前工具不保存和恢复窗口的位置和大小信息。`pygetwindow` 库提供了一些获取和设置这些信息的方法，可以在未来的版本中集成。
*   **虚拟桌面：** Windows 10/11 支持虚拟桌面，当前工具可能无法区分应用程序属于哪个虚拟桌面。
*   **更高权限应用：** 尽管建议以最高权限运行任务，但有些安全软件或策略可能会阻止本工具完全控制某些敏感应用程序的窗口。
*   **界面美化：** `tkinter` 提供了基础界面，未来可以考虑使用更现代化的 GUI 库（如 PyQt, Kivy, Streamlit 等，但这需要额外的依赖）。
*   **跨平台：** 本工具大量依赖 Windows API 和 `pygetwindow` 库（其 Windows 支持较好），目前是 Windows 专属。

## 6. 故障排除

*   **脚本无法运行 (SyntaxError, ImportError 等):**
    *   确保您安装了正确版本的 Python (3.6+)。
    *   确保您安装了所有必要的依赖库 (`pip install pygetwindow`)。
    *   如果您打包了 `.exe`，确保打包过程中没有错误。
*   **任务计划程序任务未运行：**
    *   检查任务的触发器是否设置正确。
    *   检查任务的"安全性选项"中的用户是否有权限运行程序。
    *   确保勾选了"使用最高权限运行"。
    *   查看任务计划程序的历史记录（需要在任务的"操作"窗格中启用"启用所有任务历史记录"）是否有运行失败的日志。
*   **恢复时部分应用程序/窗口无法启动或聚焦：**
    *   确保任务计划程序任务或手动运行脚本时使用了"以管理员身份运行"。
    *   检查 `config.json` 中的排除列表，确保您想恢复的应用不在排除列表中。
    *   查看日志输出，可能会有相关的错误信息（例如权限拒绝）。
    *   某些应用程序可能本身会阻止外部程序对其窗口进行操作。
    *   确认保存的应用程序路径 (`sessions.json` 中) 是否仍然有效。
*   **浏览器标签页未恢复：**
    *   确认浏览器本身是否配置为在启动时恢复上次的会话。这是本工具目前恢复浏览器标签页的依赖方式。请检查您的浏览器设置。
    *   浏览器启动命令可能无法加载保存的 URL（因为目前我们只启动了可执行文件）。

如果您遇到其他问题，请检查 `session_manager.log` 文件获取详细的错误信息，并在项目的 Issue 页面寻求帮助。
